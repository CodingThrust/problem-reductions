# PR 13 Cleanup Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Simplify PR 13 by removing redundant files while preserving all necessary tests and functionality.

**Architecture:** Remove unused backup file, duplicate JSON files, and archive Julia code to issue #17 before removal.

**Tech Stack:** Rust, Git, GitHub CLI

---

## Summary of Cleanup

| Category | Files | Lines/Size | Action |
|----------|-------|------------|--------|
| Backup file | 1 | 2,809 lines | Remove (unused) |
| Duplicate `_rust_*` JSON | 8 | ~520KB | Remove duplicates, keep one per mode |
| `_mapping_trace` JSON | 4 | ~56KB | Remove (not used by tests) |
| Julia source files | 4 | 1,477 lines | Archive to issue #17, then remove |

**Total reduction:** ~130,000 lines (backup + JSON + Julia)

---

## Task 1: Archive Julia Code to Issue #17

**Files:**
- Read: `tests/julia/dump_bull_mapping.jl` (308 lines)
- Read: `tests/julia/Project.toml` (4 lines)
- Read: `examples/debug_map_config_back.jl` (31 lines)

**Step 1: Read the Julia files**

Read `tests/julia/dump_bull_mapping.jl`, `tests/julia/Project.toml`, and `examples/debug_map_config_back.jl`.

**Step 2: Post to issue #17**

Run:
```bash
gh issue comment 17 --body "## Archived Julia Code from PR #13

This code was used to generate test trace files for comparison with the Rust implementation. Archiving here before cleanup.

### tests/julia/dump_bull_mapping.jl

\`\`\`julia
<paste content>
\`\`\`

### tests/julia/Project.toml

\`\`\`toml
<paste content>
\`\`\`

### examples/debug_map_config_back.jl

\`\`\`julia
<paste content>
\`\`\`
"
```

Expected: Comment added to issue #17

---

## Task 2: Remove Unused Backup File

**Files:**
- Delete: `src/rules/unitdiskmapping/gadgets_unweighted_backup.rs`

**Step 1: Verify file is not referenced**

Run: `grep -r "gadgets_unweighted_backup" .`
Expected: No matches found

**Step 2: Delete the backup file**

Run: `git rm src/rules/unitdiskmapping/gadgets_unweighted_backup.rs`
Expected: File removed from index

**Step 3: Verify build succeeds**

Run: `cargo build --all-features`
Expected: Build succeeds

---

## Task 3: Remove Duplicate `_rust_*` JSON Files

**Analysis:** These files are duplicates:
- `*_rust_square.json` == `*_rust_unweighted.json` (identical)
- `*_rust_stages.json` == `*_rust_triangular.json` (identical)

**Files to remove (duplicates):**
- `tests/julia/bull_rust_square.json`
- `tests/julia/diamond_rust_square.json`
- `tests/julia/house_rust_square.json`
- `tests/julia/petersen_rust_square.json`
- `tests/julia/bull_rust_stages.json`
- `tests/julia/diamond_rust_stages.json`
- `tests/julia/house_rust_stages.json`
- `tests/julia/petersen_rust_stages.json`

**Step 1: Update compare_mapping.typ to use non-duplicate names**

Edit `docs/paper/compare_mapping.typ`:
- Change `load_rust_square(name)` to load `_rust_unweighted.json`
- Change `load_rust_triangular(name)` to load `_rust_triangular.json`

Old:
```typst
#let load_rust_square(name) = json("../../tests/julia/" + name + "_rust_square.json")
#let load_rust_triangular(name) = json("../../tests/julia/" + name + "_rust_stages.json")
```

New:
```typst
#let load_rust_square(name) = json("../../tests/julia/" + name + "_rust_unweighted.json")
#let load_rust_triangular(name) = json("../../tests/julia/" + name + "_rust_triangular.json")
```

**Step 2: Update Makefile if needed**

The Makefile already uses `_rust_unweighted.json` and `_rust_triangular.json` - no changes needed.

**Step 3: Remove duplicate files**

Run:
```bash
git rm tests/julia/*_rust_square.json tests/julia/*_rust_stages.json
```

Expected: 8 files removed

---

## Task 4: Remove Unused `_mapping_trace` JSON Files

**Analysis:** These files are NOT used by any tests. The tests use `_unweighted_trace.json`, `_weighted_trace.json`, and `_triangular_trace.json` instead.

**Files to remove:**
- `tests/julia/bull_mapping_trace.json`
- `tests/julia/diamond_mapping_trace.json`
- `tests/julia/house_mapping_trace.json`
- `tests/julia/petersen_mapping_trace.json`

**Step 1: Verify files are not used**

Run: `grep -r "_mapping_trace" tests/ src/`
Expected: No matches in test files

**Step 2: Remove unused files**

Run:
```bash
git rm tests/julia/*_mapping_trace.json
```

Expected: 4 files removed

---

## Task 5: Remove Julia Source Files

**Files to remove:**
- `tests/julia/dump_bull_mapping.jl`
- `tests/julia/Project.toml`
- `tests/julia/Manifest.toml`
- `examples/debug_map_config_back.jl`

**Step 1: Remove Julia files (already archived in Task 1)**

Run:
```bash
git rm tests/julia/dump_bull_mapping.jl tests/julia/Project.toml tests/julia/Manifest.toml
git rm examples/debug_map_config_back.jl
```

Expected: 4 files removed

**Step 2: Update Makefile to remove julia-export target**

Edit `Makefile` to remove the `julia-export` target and update `compare` target.

Old:
```makefile
# Generate Julia mapping JSON exports (requires Julia with UnitDiskMapping)
julia-export:
	cd tests/julia && julia --project=. dump_bull_mapping.jl
```

Remove this target.

Also update `compare` target to not depend on `julia-export`.

---

## Task 6: Verify All Tests Pass

**Step 1: Run full test suite**

Run: `cargo test --all-features -- --include-ignored`
Expected: All tests pass

**Step 2: Verify Typst document still compiles**

Run: `cd docs/paper && typst compile compare_mapping.typ compare_mapping.pdf`
Expected: PDF generated successfully

---

## Task 7: Commit Changes

**Step 1: Stage all changes**

Run: `git add -A`

**Step 2: Commit with message**

Run:
```bash
git commit -m "$(cat <<'EOF'
chore: Clean up PR 13 - remove redundant files

- Remove gadgets_unweighted_backup.rs (2,809 lines, unused)
- Remove duplicate JSON files (*_rust_square, *_stages)
- Remove unused *_mapping_trace.json files
- Archive and remove Julia source files (see issue #17)
- Update compare_mapping.typ to use non-duplicate file names
- Remove julia-export Makefile target

Total reduction: ~130,000 lines

EOF
)"
```

---

## Files Summary

### Files to KEEP (used by tests):
- `tests/julia/gadgets_ground_truth.json` (used by gadgets_ground_truth.rs)
- `tests/julia/*_unweighted_trace.json` (used by julia_comparison.rs)
- `tests/julia/*_weighted_trace.json` (used by julia_comparison.rs)
- `tests/julia/*_triangular_trace.json` (used by julia_comparison.rs, triangular.rs)
- `tests/julia/*_rust_unweighted.json` (used by Makefile, compare_mapping.typ)
- `tests/julia/*_rust_weighted.json` (used by Makefile)
- `tests/julia/*_rust_triangular.json` (used by Makefile, compare_mapping.typ)

### Files to REMOVE:
- `src/rules/unitdiskmapping/gadgets_unweighted_backup.rs`
- `tests/julia/*_rust_square.json` (duplicate of *_rust_unweighted.json)
- `tests/julia/*_rust_stages.json` (duplicate of *_rust_triangular.json)
- `tests/julia/*_mapping_trace.json` (not used by tests)
- `tests/julia/dump_bull_mapping.jl`
- `tests/julia/Project.toml`
- `tests/julia/Manifest.toml`
- `examples/debug_map_config_back.jl`

### Plan documents (KEEP):
The plan documents in `docs/plans/` provide historical context for how features were implemented and should be kept.
